<html>
<body>
  <a id="some_link" href="google.html" target="_blank">Click Here</a>
</body>
<script>

  // The proto received on last update postmessage. Reset on getLastReceivedCompanionProto().
  lastReceivedCompanionProto = null;
  // The url received on last NotifyLinkOpen postmessage.
  lastReceivedLinkOpenedUrl = null;

  // Promise to be returned to for browser tests when the test needs to wait
  // for a postmessage call from the browser to be received by the companion
  // page.
  var promiseResolve, promiseReject;
  var promise = new Promise(function (resolve, reject) {
    promiseResolve = resolve;
    promiseReject = reject;
  });

  // Postmessage from browser.
  function onBrowserMessage(event) {
    if (event.data['type'] == 31) { // `MethodType.kUpdateCompanionPage`
      window.lastReceivedCompanionProto = event.data['companionUpdateParams'];
      promiseResolve(event.data['companionUpdateParams']);
    } else if (event.data['type'] == 32) { // `MethodType.kOnCqFindTextResultsAvailable`
      promiseResolve(event.data['cqTextFindResults']);
    } else if (event.data['type'] == 34) { // `MethodType.kNotifyLinkOpen`
      window.lastReceivedLinkOpenedUrl = event.data['openedUrl'];
      promiseResolve(event.data['openedUrl']);
    }
  }

  function getLastReceivedCompanionProto() {
    protoCopy = window.lastReceivedCompanionProto;
    window.lastReceivedCompanionProto = null;
    return protoCopy;
  }

  function getLastReceivedLinkOpenedUrl() {
    return window.lastReceivedLinkOpenedUrl;
  }

  function waitForMessage() {
    return promise;
  }

  window.addEventListener('message', onBrowserMessage, false);

</script>
</html>
